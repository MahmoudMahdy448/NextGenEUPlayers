# Staging schema profiling and detection

This document summarizes how the staging schema was generated from the project CSVs under `data/raw`, the heuristics used for type inference and canonical mapping, and where to find the generated artifacts.

## Artifacts produced

- `data/schemas/fbref_glossary_enriched.json` — flattened glossary: header -> { canonical, type_hint, desc }
- `data/schemas/canonical_mapping.json` — canonical -> [regex aliases] used to map suffixed headers
- `data/schemas/staging_schema_profiles.json` — per-table profiling output with columns that include:
  - `name`: original CSV header
  - `type`: inferred or overridden SQL type (INTEGER / REAL / TEXT / JSONB / TIMESTAMP)
  - `sample_non_null`: number of sampled non-null values
  - `sample_distinct`: number of distinct sampled values
  - `glossary_matched`: boolean indicating glossary match
  - `glossary_canonical`: canonical key when matched
- `data/schemas/staging_create_tables.sql` — generated DDL for the `staging` schema (canonical column names used where available).

## Heuristics and rules used by the profiler

1. Glossary-driven overrides
   - The flattened glossary (`fbref_glossary_enriched.json`) may include a `type_hint` for a header. If present, this overrides sampled inference and is treated as authoritative for the staging column type.
   - The profiler consults exact keys, then `canonical_mapping.json` regex aliases for robust matching (handles `_stats_*` suffixes and common FBref variants).

2. Name and sample-based inference
   - `clean_value` normalizes CSV cell values (strip, drop thousands comma, remove leading `+`).
   - Integer detection: strict regex match for integer literals.
   - Float detection: attempts float conversion; percent signs are tolerated by stripping `%`.
   - Overall rules: if all non-null samples are integers -> INTEGER; if samples include decimals or `%` -> REAL; otherwise TEXT.

3. Canonicalization
   - When a glossary canonical is found for a header, the DDL uses that canonical name (sanitized) to provide a stable analytics column name across CSV sections.
   - If multiple original headers map to the same canonical (e.g., `Gls_stats_shooting` and `Gls_stats_standard`) the DDL generator will merge them into a single column and conservatively promote types (INTEGER -> REAL -> TEXT) to ensure no data loss.

4. Identifier sanitization
   - Non-alphanumeric characters are replaced with underscores, multiple underscores collapsed, leading/trailing underscores trimmed.
   - Identifiers starting with digits or reserved/too-short tokens are prefixed with `c_` to ensure valid SQL identifiers.

5. Provenance
   - Each staging table includes `_provenance JSONB` which stores a mapping of original CSV header -> raw string for each row. This preserves raw values for auditing and re-processing.
   - `_loaded_at TIMESTAMP` added as load metadata.

## How to interpret `staging_schema_profiles.json`

Each top-level key is a generated table name. Each value is an object with `columns` (list) and `sample_rows` (number of rows sampled). The `columns` list preserves the original header name and reports whether it matched the glossary and the canonical name assigned.

Use the `glossary_matched` and `glossary_canonical` fields to audit coverage. Unmatched headers should be added to `fbref_glossary_user.json` or to `canonical_mapping.json` to improve canonicalization.

## Limitations and recommended manual steps

- `type_hint` values in the enriched glossary are heuristics and should be reviewed. Prefer to manually confirm numeric vs textual when possible.
- When two different semantic values share a canonical key (rare), consider widening the canonical key or refining `canonical_mapping.json` to avoid accidental merges.
- The profiler is conservative about types: it prefers TEXT when ambiguous. If you need tighter types (e.g., SMALLINT), update the enriched glossary and re-run.

## Files to edit for refinement

- `data/schemas/fbref_glossary_user.json` — source glossary (user-editable)
- `data/schemas/canonical_mapping.json` — add regex aliases for new header formats
- `src/generate_staging_ddl.py` — profiling & DDL logic (where heuristics live)

## Running the profiler

From project root:

```bash
python3 src/generate_staging_ddl.py
```

This will overwrite `data/schemas/staging_create_tables.sql` and `data/schemas/staging_schema_profiles.json`.

## Contact / Next steps

If you want I can:
- produce a coverage report highlighting unmatched headers (`fbref_glossary_comparison_report.json`),
- generate canonical views instead of physical canonical columns (view-based approach), or
- prepare a loader example that populates `_provenance` and `_loaded_at` for ingestion.


---
Generated by the profiling tooling in this repository.
